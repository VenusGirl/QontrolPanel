name: Update Compiled Translations
on:
  push:
    paths:
      - 'i18n/*.ts'
    branches:
      - main
  workflow_dispatch:

env:
  QT_VERSION: '6.10.1'

jobs:
  update-translations:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          add-tools-to-path: true
          cache: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Clean up obsolete translations
        run: |
          echo "Cleaning up obsolete translations from changed .ts files..."
          # Get list of changed .ts files in this push
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep 'i18n/.*\.ts$' || true)
          if [ -z "$CHANGED_FILES" ]; then
            echo "No .ts files changed in this push"
          else
            for ts_file in $CHANGED_FILES; do
              if [ -f "$ts_file" ]; then
                echo "Cleaning $ts_file"
                lconvert -no-obsolete "$ts_file" -o "${ts_file}.tmp"
                mv "${ts_file}.tmp" "$ts_file"
              fi
            done
          fi
          # Save changed files list for next step
          echo "$CHANGED_FILES" > /tmp/changed_ts_files.txt

      - name: Compile all translation files
        run: |
          echo "Compiling all .ts files to .qm files..."
          mkdir -p /tmp/qm_files
          for ts_file in i18n/*.ts; do
            if [ -f "$ts_file" ]; then
              filename=$(basename "$ts_file" .ts)
              qm_file="/tmp/qm_files/${filename}.qm"
              echo "Compiling $ts_file -> $qm_file"
              lrelease "$ts_file" -qm "$qm_file"
            fi
          done

      - name: Generate translation progress JSON
        run: |
          echo "Generating translation progress data..."
          mkdir -p /tmp/qm_files
          python3 tools/analyze_translations.py
          # Move the generated JSON to the temp directory
          mv i18n/compiled/translation_progress.json /tmp/qm_files/ 2>/dev/null || true

      - name: Push compiled files to translations repository
        env:
          TRANSLATIONS_TOKEN: ${{ secrets.TRANSLATIONS_TOKEN }}
        run: |
          # Clone the translations repository
          git clone https://x-access-token:${TRANSLATIONS_TOKEN}@github.com/Odizinne/QontrolPanelTranslations.git /tmp/translations

          # Copy all compiled QM files and progress JSON
          cp /tmp/qm_files/*.qm /tmp/translations/
          cp /tmp/qm_files/translation_progress.json /tmp/translations/

          # Commit and push to translations repo
          cd /tmp/translations
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add *.qm translation_progress.json
          if ! git diff --staged --quiet; then
            git commit -m "Auto-update compiled translations and progress data"
            git push
          else
            echo "No changes to commit"
          fi

          # Commit cleaned source .ts files back to main repo
          cd $GITHUB_WORKSPACE
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add i18n/*.ts
          if ! git diff --staged --quiet; then
            git commit -m "Clean obsolete translations [skip ci]"
            git push
          fi